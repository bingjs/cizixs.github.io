<!DOCTYPE html>
<html CN>







<head>
	
	
	<link rel="stylesheet" href="/css/allinone.min.css"> 

	

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />

	<title>ä½¿ç”¨ pprof å’Œç«ç„°å›¾è°ƒè¯• golang åº”ç”¨ | Cizixs Write Here</title>

	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
	<meta name="generator" content="hexo">
	<meta name="author" content="Cizixs Wu">
	<meta name="description" content="">

	
	<meta name="keywords" content="">
	

	
	<link rel="shortcut icon" href="https://i.loli.net/2017/11/26/5a19c0b50432e.png">
	

	
	<meta name="theme-color" content="#3c484e">
	<meta name="msapplication-TileColor" content="#3c484e">
	

	

	

	<meta property="og:site_name" content="Cizixs Write Here">
	<meta property="og:type" content="article">
	<meta property="og:title" content="ä½¿ç”¨ pprof å’Œç«ç„°å›¾è°ƒè¯• golang åº”ç”¨ | Cizixs Write Here">
	<meta property="og:description" content="">
	<meta property="og:url" content="http://cizixs.com/2017/09/11/profiling-golang-program/">

	
	<meta property="article:published_time" content="2017-09-11T00:09:00+08:00"/> 
	<meta property="article:author" content="Cizixs Wu">
	<meta property="article:published_first" content="Cizixs Write Here, /2017/09/11/profiling-golang-program/" />
	

	
	
	<script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
	

	
	<script src="https://cdn.staticfile.org/highlight.js/9.10.0/highlight.min.js"></script>
	

	
	
</head>
<body class="post-template">
    <div class="site-wrapper">
        




<header class="site-header outer" style="z-index: 999">
    <div class="inner">
        
<nav class="site-nav"> 
    <div class="site-nav-left">
        <ul class="nav">
            <li>
                
                <a href="/" title="Home">Home</a>
                
            </li>
            
            
            <li>
                <a href="/about" title="About">About</a>
            </li>
            
            <li>
                <a href="/archives" title="Archives">Archives</a>
            </li>
            
            
        </ul> 
    </div>
    <div class="site-nav-right">
        
<div class="social-links" >
    
    
    
    
    <a class="social-link" title="twitter" href="https://twitter.com/cizixs" target="_blank" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

    </a>
    
    
</div>
    </div>
</nav>
    </div>
</header>


<main id="site-main" class="site-main outer" role="main">
    <div class="inner">
        <header class="post-full-header">
            <section class="post-full-meta">
                <time  class="post-full-meta-date" datetime="2017-09-10T16:00:00.000Z" itemprop="datePublished">
                    2017-09-11
                </time>
                
                <span class="date-divider">/</span>
                
                <a href="/categories/blog/">blog</a>&nbsp;&nbsp;
                
                
            </section>
            <h1 class="post-full-title">ä½¿ç”¨ pprof å’Œç«ç„°å›¾è°ƒè¯• golang åº”ç”¨</h1>
        </header>
        <article class="post-full no-image">
            
            <section class="post-full-content">
                <div id="lightgallery" class="markdown-body">
                    <h2 id="ä»€ä¹ˆæ˜¯-Profiling"><a href="#ä»€ä¹ˆæ˜¯-Profiling" class="headerlink" title="ä»€ä¹ˆæ˜¯ Profiling?"></a>ä»€ä¹ˆæ˜¯ Profiling?</h2><p>Profiling è¿™ä¸ªè¯æ¯”è¾ƒéš¾ç¿»è¯‘ï¼Œä¸€èˆ¬è¯‘æˆ<code>ç”»åƒ</code>ã€‚æ¯”å¦‚åœ¨æ¡ˆä»¶ä¾¦ç ´çš„æ—¶å€™ä¼šå¯¹å«Œç–‘äººåšç”»åƒï¼Œä»çŠ¯ç½ªç°åœºçš„ç§ç§è¯æ®ï¼Œæ‰¾åˆ°å«Œç–‘äººçš„å„ç§ç‰¹å¾ï¼Œæ–¹ä¾¿å¯¹å«Œç–‘äººè¿›è¡Œæ’æŸ¥ï¼›è¿˜æœ‰å°±æ˜¯äº’è”ç½‘å…¬å¸ä¼šå¯¹ç”¨æˆ·ä¿¡æ¯åšç”»åƒï¼Œé€šè¿‡äº†è§£ç”¨æˆ·å„ä¸ªå±æ€§ï¼ˆå¹´é¾„ã€æ€§åˆ«ã€æ¶ˆè´¹èƒ½åŠ›ç­‰ï¼‰ï¼Œæ–¹ä¾¿ä¸ºç”¨æˆ·æ¨èå†…å®¹æˆ–è€…å¹¿å‘Šã€‚</p>
<p>åœ¨è®¡ç®—æœºæ€§èƒ½è°ƒè¯•é¢†åŸŸé‡Œï¼Œprofiling å°±æ˜¯å¯¹åº”ç”¨çš„ç”»åƒï¼Œè¿™é‡Œç”»åƒå°±æ˜¯åº”ç”¨ä½¿ç”¨ CPU å’Œå†…å­˜çš„æƒ…å†µã€‚ä¹Ÿå°±æ˜¯è¯´åº”ç”¨ä½¿ç”¨äº†å¤šå°‘ CPU èµ„æºï¼Ÿéƒ½æ˜¯å“ªäº›éƒ¨åˆ†åœ¨ä½¿ç”¨ï¼Ÿæ¯ä¸ªå‡½æ•°ä½¿ç”¨çš„æ¯”ä¾‹æ˜¯å¤šå°‘ï¼Ÿæœ‰å“ªäº›å‡½æ•°åœ¨ç­‰å¾… CPU èµ„æºï¼ŸçŸ¥é“äº†è¿™äº›ï¼Œæˆ‘ä»¬å°±èƒ½å¯¹åº”ç”¨è¿›è¡Œè§„åˆ’ï¼Œä¹Ÿèƒ½å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆã€‚</p>
<p>golang æ˜¯ä¸€ä¸ªå¯¹æ€§èƒ½ç‰¹åˆ«çœ‹é‡çš„è¯­è¨€ï¼Œå› æ­¤è¯­è¨€ä¸­è‡ªå¸¦äº† profiling çš„åº“ï¼Œè¿™ç¯‡æ–‡ç« å°±è¦è®²è§£æ€ä¹ˆåœ¨ golang ä¸­åš profilingã€‚</p>
<p>åœ¨ go è¯­è¨€ä¸­ï¼Œä¸»è¦å…³æ³¨çš„åº”ç”¨è¿è¡Œæƒ…å†µä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>CPU profileï¼šæŠ¥å‘Šç¨‹åºçš„ CPU ä½¿ç”¨æƒ…å†µï¼ŒæŒ‰ç…§ä¸€å®šé¢‘ç‡å»é‡‡é›†åº”ç”¨ç¨‹åºåœ¨ CPU å’Œå¯„å­˜å™¨ä¸Šé¢çš„æ•°æ®</li>
<li>Memory Profileï¼ˆHeap Profileï¼‰ï¼šæŠ¥å‘Šç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µ</li>
<li>Block Profilingï¼šæŠ¥å‘Š goroutines ä¸åœ¨è¿è¡ŒçŠ¶æ€çš„æƒ…å†µï¼Œå¯ä»¥ç”¨æ¥åˆ†æå’ŒæŸ¥æ‰¾æ­»é”ç­‰æ€§èƒ½ç“¶é¢ˆ</li>
<li>Goroutine Profilingï¼šæŠ¥å‘Š goroutines çš„ä½¿ç”¨æƒ…å†µï¼Œæœ‰å“ªäº› goroutineï¼Œå®ƒä»¬çš„è°ƒç”¨å…³ç³»æ˜¯æ€æ ·çš„</li>
</ul>
<h2 id="ä¸¤ç§æ”¶é›†æ–¹å¼"><a href="#ä¸¤ç§æ”¶é›†æ–¹å¼" class="headerlink" title="ä¸¤ç§æ”¶é›†æ–¹å¼"></a>ä¸¤ç§æ”¶é›†æ–¹å¼</h2><p>åš Profiling ç¬¬ä¸€æ­¥å°±æ˜¯æ€ä¹ˆè·å–åº”ç”¨ç¨‹åºçš„è¿è¡Œæƒ…å†µæ•°æ®ã€‚go è¯­è¨€æä¾›äº† <code>runtime/pprof</code> å’Œ <code>net/http/pprof</code> ä¸¤ä¸ªåº“ï¼Œè¿™éƒ¨åˆ†æˆ‘ä»¬è®²è®²å®ƒä»¬çš„ç”¨æ³•ä»¥åŠä½¿ç”¨åœºæ™¯ã€‚</p>
<h3 id="å·¥å…·å‹åº”ç”¨"><a href="#å·¥å…·å‹åº”ç”¨" class="headerlink" title="å·¥å…·å‹åº”ç”¨"></a>å·¥å…·å‹åº”ç”¨</h3><p>å¦‚æœä½ çš„åº”ç”¨æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè¿è¡Œä¸€æ®µæ—¶é—´å°±ç»“æŸã€‚é‚£ä¹ˆæœ€å¥½çš„åŠæ³•ï¼Œå°±æ˜¯åœ¨åº”ç”¨é€€å‡ºçš„æ—¶å€™æŠŠ profiling çš„æŠ¥å‘Šä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œè¿›è¡Œåˆ†æã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ <a href="https://golang.org/pkg/runtime/pprof/" target="_blank" rel="noopener"><code>runtime/pprof</code> åº“</a>ã€‚</p>
<p><code>pprof</code> å°è£…äº†å¾ˆå¥½çš„æ¥å£ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼Œæ¯”å¦‚è¦æƒ³è¿›è¡Œ CPU Profilingï¼Œå¯ä»¥è°ƒç”¨ <code>pprof.StartCPUProfile()</code> æ–¹æ³•ï¼Œå®ƒä¼šå¯¹å½“å‰åº”ç”¨ç¨‹åºè¿›è¡Œ CPU profilingï¼Œå¹¶å†™å…¥åˆ°æä¾›çš„å‚æ•°ä¸­ï¼ˆ<code>w io.Writer</code>ï¼‰ï¼Œè¦åœæ­¢è°ƒç”¨ <code>StopCPUProfile()</code> å³å¯ã€‚</p>
<p>å»é™¤é”™è¯¯å¤„ç†åªéœ€è¦ä¸‰è¡Œå†…å®¹ï¼Œä¸€èˆ¬æŠŠéƒ¨åˆ†å†…å®¹å†™åœ¨ <code>main.go</code> æ–‡ä»¶ä¸­ï¼Œåº”ç”¨ç¨‹åºå¯åŠ¨ä¹‹åå°±å¼€å§‹æ‰§è¡Œï¼š</p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line">f, err := os.Create<span class="comment">(*cpuprofile)</span></span><br><span class="line">...</span><br><span class="line">pprof.StartCPUProfile<span class="comment">(f)</span></span><br><span class="line">defer pprof.StopCPUProfile<span class="comment">()</span></span><br></pre></td></tr></table></figure>
<p>åº”ç”¨æ‰§è¡Œç»“æŸåï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Œä¿å­˜äº†æˆ‘ä»¬çš„ CPU profiling æ•°æ®ã€‚</p>
<p>æƒ³è¦è·å¾—å†…å­˜çš„æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨ <code>WriteHeapProfile</code> å°±è¡Œï¼Œä¸ç”¨ <code>start</code> å’Œ <code>stop</code> è¿™ä¸¤ä¸ªæ­¥éª¤äº†ï¼š</p>
<figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line">f, err := os.Create<span class="comment">(*memprofile)</span></span><br><span class="line">pprof.WriteHeapProfile<span class="comment">(f)</span></span><br><span class="line">f.Close<span class="comment">()</span></span><br></pre></td></tr></table></figure>
<h3 id="æœåŠ¡å‹åº”ç”¨"><a href="#æœåŠ¡å‹åº”ç”¨" class="headerlink" title="æœåŠ¡å‹åº”ç”¨"></a>æœåŠ¡å‹åº”ç”¨</h3><p>å¦‚æœä½ çš„åº”ç”¨æ˜¯ä¸€ç›´è¿è¡Œçš„ï¼Œæ¯”å¦‚ web åº”ç”¨ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ <code>net/http/pprof</code> åº“ï¼Œå®ƒèƒ½å¤Ÿåœ¨æä¾› HTTP æœåŠ¡è¿›è¡Œåˆ†æã€‚</p>
<p>å¦‚æœä½¿ç”¨äº†é»˜è®¤çš„ <code>http.DefaultServeMux</code>ï¼ˆé€šå¸¸æ˜¯ä»£ç ç›´æ¥ä½¿ç”¨ <code>http.ListenAndServe(&quot;0.0.0.0:8000&quot;, nil)</code>ï¼‰ï¼Œåªéœ€è¦æ·»åŠ ä¸€è¡Œï¼š</p>
<figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="literal">_</span> <span class="string">"net/http/pprof"</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœä½ ä½¿ç”¨è‡ªå®šä¹‰çš„ <code>Mux</code>ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨æ³¨å†Œä¸€äº›è·¯ç”±è§„åˆ™ï¼š</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">r</span><span class="selector-class">.HandleFunc</span>(<span class="string">"/debug/pprof/"</span>, pprof.Index)</span><br><span class="line"><span class="selector-tag">r</span><span class="selector-class">.HandleFunc</span>(<span class="string">"/debug/pprof/cmdline"</span>, pprof.Cmdline)</span><br><span class="line"><span class="selector-tag">r</span><span class="selector-class">.HandleFunc</span>(<span class="string">"/debug/pprof/profile"</span>, pprof.Profile)</span><br><span class="line"><span class="selector-tag">r</span><span class="selector-class">.HandleFunc</span>(<span class="string">"/debug/pprof/symbol"</span>, pprof.Symbol)</span><br><span class="line"><span class="selector-tag">r</span><span class="selector-class">.HandleFunc</span>(<span class="string">"/debug/pprof/trace"</span>, pprof.Trace)</span><br></pre></td></tr></table></figure>
<p>ä¸ç®¡å“ªç§æ–¹å¼ï¼Œä½ çš„ HTTP æœåŠ¡éƒ½ä¼šå¤šå‡º <code>/debug/pprof</code> endpointï¼Œè®¿é—®å®ƒä¼šå¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„å†…å®¹ï¼š</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">/<span class="keyword">debug</span>/pprof/</span><br><span class="line"></span><br><span class="line"><span class="keyword">profile</span><span class="variable">s:</span></span><br><span class="line"><span class="number">0</span>	block</span><br><span class="line"><span class="number">62</span>	goroutine</span><br><span class="line"><span class="number">444</span>	heap</span><br><span class="line"><span class="number">30</span>	threadcreate</span><br><span class="line"></span><br><span class="line">full goroutine stack dump</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªè·¯å¾„ä¸‹è¿˜æœ‰å‡ ä¸ªå­é¡µé¢ï¼š</p>
<ul>
<li><code>/debug/pprof/profile</code>ï¼šè®¿é—®è¿™ä¸ªé“¾æ¥ä¼šè‡ªåŠ¨è¿›è¡Œ CPU profilingï¼ŒæŒç»­ 30sï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ä¾›ä¸‹è½½</li>
<li><code>/debug/pprof/heap</code>ï¼š Memory Profiling çš„è·¯å¾„ï¼Œè®¿é—®è¿™ä¸ªé“¾æ¥ä¼šå¾—åˆ°ä¸€ä¸ªå†…å­˜ Profiling ç»“æœçš„æ–‡ä»¶</li>
<li><code>/debug/pprof/block</code>ï¼šblock Profiling çš„è·¯å¾„</li>
<li><code>/debug/pprof/goroutines</code>ï¼šè¿è¡Œçš„ goroutines åˆ—è¡¨ï¼Œä»¥åŠè°ƒç”¨å…³ç³»</li>
</ul>
<h2 id="go-tool-pprof-å‘½ä»¤ï¼šè·å–å’Œåˆ†æ-Profiling-æ•°æ®"><a href="#go-tool-pprof-å‘½ä»¤ï¼šè·å–å’Œåˆ†æ-Profiling-æ•°æ®" class="headerlink" title="go tool pprof å‘½ä»¤ï¼šè·å–å’Œåˆ†æ Profiling æ•°æ®"></a>go tool pprof å‘½ä»¤ï¼šè·å–å’Œåˆ†æ Profiling æ•°æ®</h2><p>èƒ½é€šè¿‡å¯¹åº”çš„åº“è·å–æƒ³è¦çš„ Profiling æ•°æ®ä¹‹åï¼ˆä¸ç®¡æ˜¯æ–‡ä»¶è¿˜æ˜¯ httpï¼‰ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è¦å¯¹è¿™äº›æ•°æ®è¿›è¡Œä¿å­˜å’Œåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>go tool pprof</code> å‘½ä»¤è¡Œå·¥å…·ã€‚</p>
<p>åœ¨åé¢æˆ‘ä»¬ä¼šç”Ÿæˆè°ƒç”¨å…³ç³»å›¾å’Œç«ç„°å›¾ï¼Œéœ€è¦å®‰è£… <code>graphviz</code> è½¯ä»¶åŒ…ï¼Œåœ¨ ubuntu ç³»ç»Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ sudo apt-<span class="builtin-name">get</span> install -y graphviz</span><br></pre></td></tr></table></figure>
<p><strong>NOTE</strong>ï¼šè·å–çš„ Profiling æ•°æ®æ˜¯åŠ¨æ€çš„ï¼Œè¦æƒ³è·å¾—æœ‰æ•ˆçš„æ•°æ®ï¼Œè¯·ä¿è¯åº”ç”¨å¤„äºè¾ƒå¤§çš„è´Ÿè½½ï¼ˆæ¯”å¦‚æ­£åœ¨ç”Ÿæˆä¸­è¿è¡Œçš„æœåŠ¡ï¼Œæˆ–è€…é€šè¿‡å…¶ä»–å·¥å…·æ¨¡æ‹Ÿè®¿é—®å‹åŠ›ï¼‰ã€‚å¦åˆ™å¦‚æœåº”ç”¨å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¾—åˆ°çš„ç»“æœå¯èƒ½æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚</p>
<h3 id="CPU-Profiling"><a href="#CPU-Profiling" class="headerlink" title="CPU Profiling"></a>CPU Profiling</h3><p><code>go tool pprof</code> æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼ä¸º <code>go tool pprof [binary] [source]</code>ï¼Œ<code>binary</code> æ˜¯åº”ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”¨æ¥è§£æå„ç§ç¬¦å·ï¼›<code>source</code> è¡¨ç¤º profile æ•°æ®çš„æ¥æºï¼Œå¯ä»¥æ˜¯æœ¬åœ°çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ http åœ°å€ã€‚æ¯”å¦‚ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">âœ  go tool pprof ./hyperkube http:<span class="comment">//172.16.3.232:10251/debug/pprof/profile</span></span><br><span class="line">Fetching profile from http:<span class="comment">//172.16.3.232:10251/debug/pprof/profile</span></span><br><span class="line">Please wait... (<span class="number">30s</span>)</span><br><span class="line">Saved profile <span class="keyword">in</span> /home/cizixs/pprof/pprof<span class="selector-class">.hyperkube</span>.<span class="number">172.16</span>.<span class="number">3.232</span>:<span class="number">10251</span><span class="selector-class">.samples</span><span class="selector-class">.cpu</span>.<span class="number">002</span><span class="selector-class">.pb</span><span class="selector-class">.gz</span></span><br><span class="line">Entering interactive mode (type <span class="string">"help"</span> <span class="keyword">for</span> commands)</span><br><span class="line">(pprof)</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‘½ä»¤ä¼šè¿›è¡Œ CPU profiling åˆ†æï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ï¼ˆé»˜è®¤æ˜¯ 30sï¼Œå¦‚æœåœ¨ url æœ€ååŠ ä¸Š <code>?seconds=60</code> å‚æ•°å¯ä»¥è°ƒæ•´é‡‡é›†æ•°æ®çš„æ—¶é—´ä¸º 60sï¼‰ä¹‹åï¼Œæˆ‘ä»¬å°±è¿›å…¥äº†ä¸€ä¸ªäº¤äº’å¼å‘½ä»¤è¡Œï¼Œå¯ä»¥å¯¹è§£æçš„ç»“æœè¿›è¡ŒæŸ¥çœ‹å’Œå¯¼å‡ºã€‚å¯ä»¥é€šè¿‡ <code>help</code> æ¥æŸ¥çœ‹æ”¯æŒçš„è‡ªå‘½ä»¤æœ‰å“ªäº›ã€‚</p>
<p>ä¸€ä¸ªæœ‰ç”¨çš„å‘½ä»¤æ˜¯ <code>topN</code>ï¼Œå®ƒåˆ—å‡ºæœ€è€—æ—¶é—´çš„åœ°æ–¹ï¼š</p>
<figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">(pprof) top10</span><br><span class="line"><span class="number">130</span>ms of <span class="number">360</span>ms total (<span class="number">36.11</span>%)</span><br><span class="line">Showing top <span class="number">10</span> nodes out of <span class="number">180</span> (cum &gt;= <span class="number">10</span>ms)</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">      <span class="number">20</span>ms  <span class="number">5.56</span>%  <span class="number">5.56</span>%      <span class="number">100</span>ms <span class="number">27.78</span>%  encoding/json.(*decodeState).object</span><br><span class="line">      <span class="number">20</span>ms  <span class="number">5.56</span>% <span class="number">11.11</span>%       <span class="number">20</span>ms  <span class="number">5.56</span>%  runtime.(*mspan).refillAllocCache</span><br><span class="line">      <span class="number">20</span>ms  <span class="number">5.56</span>% <span class="number">16.67</span>%       <span class="number">20</span>ms  <span class="number">5.56</span>%  runtime.futex</span><br><span class="line">      <span class="number">10</span>ms  <span class="number">2.78</span>% <span class="number">19.44</span>%       <span class="number">10</span>ms  <span class="number">2.78</span>%  encoding/json.(*decodeState).literalStore</span><br><span class="line">      <span class="number">10</span>ms  <span class="number">2.78</span>% <span class="number">22.22</span>%       <span class="number">10</span>ms  <span class="number">2.78</span>%  encoding/json.(*decodeState).scanWhile</span><br><span class="line">      <span class="number">10</span>ms  <span class="number">2.78</span>% <span class="number">25.00</span>%       <span class="number">40</span>ms <span class="number">11.11</span>%  encoding/json.checkValid</span><br><span class="line">      <span class="number">10</span>ms  <span class="number">2.78</span>% <span class="number">27.78</span>%       <span class="number">10</span>ms  <span class="number">2.78</span>%  encoding/json.simpleLetterEqualFold</span><br><span class="line">      <span class="number">10</span>ms  <span class="number">2.78</span>% <span class="number">30.56</span>%       <span class="number">10</span>ms  <span class="number">2.78</span>%  encoding/json.stateBeginValue</span><br><span class="line">      <span class="number">10</span>ms  <span class="number">2.78</span>% <span class="number">33.33</span>%       <span class="number">10</span>ms  <span class="number">2.78</span>%  encoding/json.stateEndValue</span><br><span class="line">      <span class="number">10</span>ms  <span class="number">2.78</span>% <span class="number">36.11</span>%       <span class="number">10</span>ms  <span class="number">2.78</span>%  encoding/json.stateInString</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸€è¡Œè¡¨ç¤ºä¸€ä¸ªå‡½æ•°çš„ä¿¡æ¯ã€‚å‰ä¸¤åˆ—è¡¨ç¤ºå‡½æ•°åœ¨ CPU ä¸Šè¿è¡Œçš„æ—¶é—´ä»¥åŠç™¾åˆ†æ¯”ï¼›ç¬¬ä¸‰åˆ—æ˜¯å½“å‰æ‰€æœ‰å‡½æ•°ç´¯åŠ ä½¿ç”¨ CPU çš„æ¯”ä¾‹ï¼›ç¬¬å››åˆ—å’Œç¬¬äº”åˆ—ä»£è¡¨è¿™ä¸ªå‡½æ•°ä»¥åŠå­å‡½æ•°è¿è¡Œæ‰€å ç”¨çš„æ—¶é—´å’Œæ¯”ä¾‹ï¼ˆä¹Ÿè¢«ç§°ä¸º<code>ç´¯åŠ å€¼ cumulative</code>ï¼‰ï¼Œåº”è¯¥å¤§äºç­‰äºå‰ä¸¤åˆ—çš„å€¼ï¼›æœ€åä¸€åˆ—å°±æ˜¯å‡½æ•°çš„åå­—ã€‚å¦‚æœåº”ç”¨ç¨‹åºæœ‰æ€§èƒ½é—®é¢˜ï¼Œä¸Šé¢è¿™äº›ä¿¡æ¯åº”è¯¥èƒ½å‘Šè¯‰æˆ‘ä»¬æ—¶é—´éƒ½èŠ±è´¹åœ¨å“ªäº›å‡½æ•°çš„æ‰§è¡Œä¸Šäº†ã€‚</p>
<p>pprof ä¸ä»…èƒ½æ‰“å°å‡ºæœ€è€—æ—¶çš„åœ°æ–¹(<code>top</code>)ï¼Œè¿˜èƒ½åˆ—å‡ºå‡½æ•°ä»£ç ä»¥åŠå¯¹åº”çš„å–æ ·æ•°æ®(<code>list</code>)ã€æ±‡ç¼–ä»£ç ä»¥åŠå¯¹åº”çš„å–æ ·æ•°æ®(<code>disasm</code>)ï¼Œè€Œä¸”èƒ½ä»¥å„ç§æ ·å¼è¿›è¡Œè¾“å‡ºï¼Œæ¯”å¦‚ svgã€gvã€callgrindã€pngã€gifç­‰ç­‰ã€‚</p>
<p>å…¶ä¸­ä¸€ä¸ªéå¸¸ä¾¿åˆ©çš„æ˜¯ <code>web</code> å‘½ä»¤ï¼Œåœ¨äº¤äº’æ¨¡å¼ä¸‹è¾“å…¥ <code>web</code>ï¼Œå°±èƒ½è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª <code>svg</code> æ–‡ä»¶ï¼Œå¹¶è·³è½¬åˆ°æµè§ˆå™¨æ‰“å¼€ï¼Œç”Ÿæˆäº†ä¸€ä¸ªå‡½æ•°è°ƒç”¨å›¾ï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fjfq8wjqunj31fa0q3afd.jpg" alt=""></p>
<p>è¿™ä¸ªè°ƒç”¨å›¾åŒ…å«äº†æ›´å¤šçš„ä¿¡æ¯ï¼Œè€Œä¸”å¯è§†åŒ–çš„å›¾åƒèƒ½è®©æˆ‘ä»¬æ›´æ¸…æ¥šåœ°ç†è§£æ•´ä¸ªåº”ç”¨ç¨‹åºçš„å…¨è²Œã€‚å›¾ä¸­æ¯ä¸ªæ–¹æ¡†å¯¹åº”ä¸€ä¸ªå‡½æ•°ï¼Œæ–¹æ¡†è¶Šå¤§ä»£è¡¨æ‰§è¡Œçš„æ—¶é—´è¶Šä¹…ï¼ˆåŒ…æ‹¬å®ƒè°ƒç”¨çš„å­å‡½æ•°æ‰§è¡Œæ—¶é—´ï¼Œä½†å¹¶ä¸æ˜¯æ­£æ¯”çš„å…³ç³»ï¼‰ï¼›æ–¹æ¡†ä¹‹é—´çš„ç®­å¤´ä»£è¡¨ç€è°ƒç”¨å…³ç³»ï¼Œç®­å¤´ä¸Šçš„æ•°å­—ä»£è¡¨è¢«è°ƒç”¨å‡½æ•°çš„æ‰§è¡Œæ—¶é—´ã€‚</p>
<p>å› ä¸ºåŸå›¾æ¯”è¾ƒå¤§ï¼Œè¿™é‡Œåªæˆªå–äº†å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯èƒ½æ˜æ˜¾çœ‹åˆ° <code>encoding/json.(*decodeState).object</code> æ˜¯è¿™é‡Œè€—æ—¶æ¯”è¾ƒå¤šçš„åœ°æ–¹ï¼Œè€Œä¸”èƒ½çœ‹åˆ°å®ƒè°ƒç”¨äº†å“ªäº›å‡½æ•°ï¼Œåˆ†åˆ«å‡½æ•°å¤šå°‘ã€‚è¿™äº›æ›´è¯¦ç»†çš„ä¿¡æ¯å¯¹äºå®šä½å’Œè°ƒä¼˜æ€§èƒ½æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ï¼</p>
<p>è¦æƒ³æ›´ç»†è‡´åˆ†æï¼Œå°±è¦ç²¾ç¡®åˆ°ä»£ç çº§åˆ«äº†ï¼Œçœ‹çœ‹æ¯è¡Œä»£ç çš„è€—æ—¶ï¼Œç›´æ¥å®šä½åˆ°å‡ºç°æ€§èƒ½é—®é¢˜çš„é‚£è¡Œä»£ç ã€‚<code>pprof</code> ä¹Ÿèƒ½åšåˆ°ï¼Œ<code>list</code> å‘½ä»¤åé¢è·Ÿç€ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œå°±èƒ½æŸ¥çœ‹åŒ¹é…å‡½æ•°çš„ä»£ç ä»¥åŠæ¯è¡Œä»£ç çš„è€—æ—¶ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">(pprof) list podFitsOnNode</span><br><span class="line">Total: <span class="number">120</span>ms</span><br><span class="line">ROUTINE ======================== k8s.io/kubernetes/plugin/pkg/scheduler.podFitsOnNode in /home/cizixs/<span class="keyword">go</span>/src/k8s.io/kubernetes/_output/local/<span class="keyword">go</span>/src/k8s.io/kubernetes/plugin/pkg/scheduler/generic_scheduler.<span class="keyword">go</span></span><br><span class="line">         <span class="number">0</span>       <span class="number">20</span>ms (flat, cum) <span class="number">16.67</span>% of Total</span><br><span class="line">         .          .    <span class="number">230</span>:</span><br><span class="line">         .          .    <span class="number">231</span>:<span class="comment">// Checks whether node with a given name and NodeInfo satisfies all predicateFuncs.</span></span><br><span class="line">         .          .    <span class="number">232</span>:<span class="function"><span class="keyword">func</span> <span class="title">podFitsOnNode</span><span class="params">(pod *api.Pod, meta <span class="keyword">interface</span>&#123;&#125;, info *schedulercache.NodeInfo, predicateFuncs <span class="keyword">map</span>[<span class="keyword">string</span>]algorithm.FitPredicate)</span> <span class="params">(<span class="keyword">bool</span>, []algorithm.PredicateFailureReason, error)</span></span> &#123;</span><br><span class="line">         .          .    <span class="number">233</span>:	<span class="keyword">var</span> failedPredicates []algorithm.PredicateFailureReason</span><br><span class="line">         .          .    <span class="number">234</span>:	<span class="keyword">for</span> _, predicate := <span class="keyword">range</span> predicateFuncs &#123;</span><br><span class="line">         .       <span class="number">20</span>ms    <span class="number">235</span>:		fit, reasons, err := predicate(pod, meta, info)</span><br><span class="line">         .          .    <span class="number">236</span>:		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         .          .    <span class="number">237</span>:			err := fmt.Errorf(<span class="string">"SchedulerPredicates failed due to %v, which is unexpected."</span>, err)</span><br><span class="line">         .          .    <span class="number">238</span>:			<span class="keyword">return</span> <span class="literal">false</span>, []algorithm.PredicateFailureReason&#123;&#125;, err</span><br><span class="line">         .          .    <span class="number">239</span>:		&#125;</span><br><span class="line">         .          .    <span class="number">240</span>:		<span class="keyword">if</span> !fit &#123;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæƒ³è¦äº†è§£å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨ <code>disadm &lt;regex&gt;</code> å‘½ä»¤ã€‚è¿™ä¸¤ä¸ªå‘½ä»¤è™½ç„¶å¼ºå¤§ï¼Œä½†æ˜¯åœ¨å‘½ä»¤è¡Œä¸­æŸ¥çœ‹ä»£ç å¹¶ä¸æ˜¯å¾ˆæ–¹é¢ï¼Œæ‰€ä»¥ä½ å¯ä»¥ä½¿ç”¨ <code>weblist</code> å‘½ä»¤ï¼Œç”¨æ³•å’Œä¸¤è€…ä¸€æ ·ï¼Œä½†å®ƒä¼šåœ¨æµè§ˆå™¨æ‰“å¼€ä¸€ä¸ªé¡µé¢ï¼Œèƒ½å¤ŸåŒæ—¶æ˜¾ç¤ºæºä»£ç å’Œæ±‡ç¼–ä»£ç ã€‚ </p>
<p><strong>NOTE</strong>ï¼šæ›´è¯¦ç»†çš„ pprof ä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒ <code>pprof --help</code> æˆ–è€… <a href="https://github.com/google/pprof/blob/master/doc/pprof.md" target="_blank" rel="noopener">pprof æ–‡æ¡£</a>ã€‚</p>
<h3 id="Memory-Profiling"><a href="#Memory-Profiling" class="headerlink" title="Memory Profiling"></a>Memory Profiling</h3><p>è¦æƒ³è·å¾—å†…å­˜ä½¿ç”¨ Profiling ä¿¡æ¯ï¼Œåªéœ€è¦æŠŠæ•°æ®æºä¿®æ”¹ä¸€ä¸‹å°±è¡Œï¼ˆå¯¹äº http æ–¹å¼æ¥è¯´å°±æ˜¯ä¿®æ”¹ url çš„åœ°å€ï¼Œä» <code>/debug/pprof/profile</code> æ”¹æˆ <code>/debug/pprof/heap</code>ï¼‰ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">âœ  go tool pprof ./hyperkube http:<span class="comment">//172.16.3.232:10251/debug/pprof/heap        </span></span><br><span class="line">Fetching profile from http:<span class="comment">//172.16.3.232:10251/debug/pprof/heap</span></span><br><span class="line">Saved profile <span class="keyword">in</span> /home/cizixs/pprof/pprof<span class="selector-class">.hyperkube</span>.<span class="number">172.16</span>.<span class="number">3.232</span>:<span class="number">10251</span><span class="selector-class">.inuse_objects</span><span class="selector-class">.inuse_space</span>.<span class="number">002</span><span class="selector-class">.pb</span><span class="selector-class">.gz</span></span><br><span class="line">Entering interactive mode (type <span class="string">"help"</span> <span class="keyword">for</span> commands)</span><br><span class="line">(pprof)</span><br></pre></td></tr></table></figure>
<p>å’Œ CPU Profiling ä½¿ç”¨ä¸€æ ·ï¼Œä½¿ç”¨ <code>top N</code> å¯ä»¥æ‰“å°å‡ºä½¿ç”¨å†…å­˜æœ€å¤šçš„å‡½æ•°åˆ—è¡¨ï¼š</p>
<figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">(pprof) top</span><br><span class="line"><span class="number">11712.11</span>kB of <span class="number">14785.10</span>kB total (<span class="number">79.22</span>%)</span><br><span class="line">Dropped <span class="number">580</span> nodes (cum &lt;= <span class="number">73.92</span>kB)</span><br><span class="line">Showing top <span class="number">10</span> nodes out of <span class="number">146</span> (cum &gt;= <span class="number">512.31</span>kB)</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line"> <span class="number">2072.09</span>kB <span class="number">14.01</span>% <span class="number">14.01</span>%  <span class="number">2072.09</span>kB <span class="number">14.01</span>%  k8s.io/kubernetes/vendor/github.com/beorn7/perks/quantile.NewTargeted</span><br><span class="line"> <span class="number">2049.25</span>kB <span class="number">13.86</span>% <span class="number">27.87</span>%  <span class="number">2049.25</span>kB <span class="number">13.86</span>%  k8s.io/kubernetes/pkg/api/v1.(*ResourceRequirements).Unmarshal</span><br><span class="line"> <span class="number">1572.28</span>kB <span class="number">10.63</span>% <span class="number">38.51</span>%  <span class="number">1572.28</span>kB <span class="number">10.63</span>%  k8s.io/kubernetes/vendor/github.com/beorn7/perks/quantile.(*stream).merge</span><br><span class="line"> <span class="number">1571.34</span>kB <span class="number">10.63</span>% <span class="number">49.14</span>%  <span class="number">1571.34</span>kB <span class="number">10.63</span>%  regexp.(*bitState).reset</span><br><span class="line"> <span class="number">1184.27</span>kB  <span class="number">8.01</span>% <span class="number">57.15</span>%  <span class="number">1184.27</span>kB  <span class="number">8.01</span>%  bytes.makeSlice</span><br><span class="line"> <span class="number">1024.16</span>kB  <span class="number">6.93</span>% <span class="number">64.07</span>%  <span class="number">1024.16</span>kB  <span class="number">6.93</span>%  k8s.io/kubernetes/pkg/api/v1.(*ObjectMeta).Unmarshal</span><br><span class="line">  <span class="number">613.99</span>kB  <span class="number">4.15</span>% <span class="number">68.23</span>%  <span class="number">2150.63</span>kB <span class="number">14.55</span>%  k8s.io/kubernetes/pkg/api/v1.(*PersistentVolumeClaimList).Unmarshal</span><br><span class="line">  <span class="number">591.75</span>kB  <span class="number">4.00</span>% <span class="number">72.23</span>%  <span class="number">1103.79</span>kB  <span class="number">7.47</span>%  reflect.Value.call</span><br><span class="line">  <span class="number">520.67</span>kB  <span class="number">3.52</span>% <span class="number">75.75</span>%   <span class="number">520.67</span>kB  <span class="number">3.52</span>%  k8s.io/kubernetes/vendor/github.com/gogo/protobuf/proto.RegisterType</span><br><span class="line">  <span class="number">512.31</span>kB  <span class="number">3.47</span>% <span class="number">79.22</span>%   <span class="number">512.31</span>kB  <span class="number">3.47</span>%  k8s.io/kubernetes/pkg/api/v1.(*PersistentVolumeClaimStatus).Unmarshal</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸€åˆ—çš„å«ä¹‰ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡ä» CPU ä½¿ç”¨æ—¶é—´å˜æˆäº†å†…å­˜ä½¿ç”¨å¤§å°ï¼Œå°±ä¸å¤šè§£é‡Šäº†ã€‚</p>
<p>ç±»ä¼¼çš„ï¼Œ<code>web</code> å‘½ä»¤ä¹Ÿèƒ½ç”Ÿæˆ <code>svg</code> å›¾ç‰‡åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œä»ä¸­å¯ä»¥çœ‹åˆ°å‡½æ•°è°ƒç”¨å…³ç³»ï¼Œä»¥åŠæ¯ä¸ªå‡½æ•°çš„å†…å­˜ä½¿ç”¨å¤šå°‘ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç»Ÿè®¡çš„æ˜¯å†…å­˜ä½¿ç”¨å¤§å°ï¼Œå¦‚æœæ‰§è¡Œå‘½ä»¤çš„æ—¶å€™åŠ ä¸Š <code>--inuse_objects</code> å¯ä»¥æŸ¥çœ‹æ¯ä¸ªå‡½æ•°åˆ†é…çš„å¯¹è±¡æ•°ï¼›<code>--alloc-space</code> æŸ¥çœ‹åˆ†é…çš„å†…å­˜ç©ºé—´å¤§å°ã€‚</p>
<p>è¿™é‡Œè¿˜è¦æä¸¤ä¸ªæ¯”è¾ƒæœ‰ç”¨çš„æ–¹æ³•ï¼Œå¦‚æœåº”ç”¨æ¯”è¾ƒå¤æ‚ï¼Œç”Ÿæˆçš„è°ƒç”¨å›¾ç‰¹åˆ«å¤§ï¼Œçœ‹èµ·æ¥å¾ˆä¹±ï¼Œæœ‰ä¸¤ä¸ªåŠæ³•å¯ä»¥ä¼˜åŒ–ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>web funcName</code> çš„æ–¹å¼ï¼Œåªæ‰“å°å’ŒæŸä¸ªå‡½æ•°ç›¸å…³çš„å†…å®¹</li>
<li>è¿è¡Œ <code>go tool pprof</code> å‘½ä»¤æ—¶åŠ ä¸Š <code>--nodefration=0.05</code> å‚æ•°ï¼Œè¡¨ç¤ºå¦‚æœè°ƒç”¨çš„å­å‡½æ•°ä½¿ç”¨çš„ CPUã€memory ä¸è¶…è¿‡ 5%ï¼Œå°±å¿½ç•¥å®ƒï¼Œä¸è¦æ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸­</li>
</ul>
<p>pprof å·²ç»æ”¯æŒåŠ¨æ€çš„ web æµè§ˆæ–¹å¼ï¼š<a href="https://github.com/google/pprof/commit/f83a3d89c18c445178f794d525bf3013ef7b3330" target="_blank" rel="noopener">https://github.com/google/pprof/commit/f83a3d89c18c445178f794d525bf3013ef7b3330</a></p>
<h2 id="go-torch-å’Œç«ç„°å›¾"><a href="#go-torch-å’Œç«ç„°å›¾" class="headerlink" title="go-torch å’Œç«ç„°å›¾"></a>go-torch å’Œç«ç„°å›¾</h2><p>ç«ç„°å›¾ï¼ˆFlame Graphï¼‰æ˜¯ Bredan Gregg åˆ›å»ºçš„ä¸€ç§æ€§èƒ½åˆ†æå›¾è¡¨ï¼Œå› ä¸ºå®ƒçš„æ ·å­è¿‘ä¼¼ ğŸ”¥è€Œå¾—åã€‚ä¸Šé¢çš„ profiling ç»“æœä¹Ÿè½¬æ¢æˆç«ç„°å›¾ï¼Œå¦‚æœå¯¹ç«ç„°å›¾æ¯”è¾ƒäº†è§£å¯ä»¥æ‰‹åŠ¨æ¥æ“ä½œï¼Œä¸è¿‡è¿™é‡Œæˆ‘ä»¬è¦ä»‹ç»ä¸€ä¸ªå·¥å…·ï¼š<a href="https://github.com/uber/go-torch" target="_blank" rel="noopener">go-torch</a>ã€‚è¿™æ˜¯ uber å¼€æºçš„ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥ç›´æ¥è¯»å– golang profiling æ•°æ®ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªç«ç„°å›¾çš„ svg æ–‡ä»¶ã€‚</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fjc5nh6x52j30xc0litck.jpg" alt=""></p>
<p>ç«ç„°å›¾ svg æ–‡ä»¶å¯ä»¥é€šè¿‡æµè§ˆå™¨æ‰“å¼€ï¼Œå®ƒå¯¹äºè°ƒç”¨å›¾çš„æœ€ä¼˜ç‚¹æ˜¯å®ƒæ˜¯åŠ¨æ€çš„ï¼šå¯ä»¥é€šè¿‡ç‚¹å‡»æ¯ä¸ªæ–¹å—æ¥ zoom in åˆ†æå®ƒä¸Šé¢çš„å†…å®¹ã€‚</p>
<p>ç«ç„°å›¾çš„è°ƒç”¨é¡ºåºä»ä¸‹åˆ°ä¸Šï¼Œæ¯ä¸ªæ–¹å—ä»£è¡¨ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä¸Šé¢ä¸€å±‚è¡¨ç¤ºè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨å“ªäº›å‡½æ•°ï¼Œæ–¹å—çš„å¤§å°ä»£è¡¨äº†å ç”¨ CPU ä½¿ç”¨çš„é•¿çŸ­ã€‚ç«ç„°å›¾çš„é…è‰²å¹¶æ²¡æœ‰ç‰¹æ®Šçš„æ„ä¹‰ï¼Œé»˜è®¤çš„çº¢ã€é»„é…è‰²æ˜¯ä¸ºäº†æ›´åƒç«ç„°è€Œå·²ã€‚</p>
<p>go-torch å·¥å…·çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œæ²¡æœ‰ä»»ä½•å‚æ•°çš„è¯ï¼Œå®ƒä¼šå°è¯•ä» <code>http://localhost:8080/debug/pprof/profile</code> è·å– profiling æ•°æ®ã€‚å®ƒæœ‰ä¸‰ä¸ªå¸¸ç”¨çš„å‚æ•°å¯ä»¥è°ƒæ•´ï¼š</p>
<ul>
<li><code>-u --url</code>ï¼šè¦è®¿é—®çš„ URLï¼Œè¿™é‡Œåªæ˜¯ä¸»æœºå’Œç«¯å£éƒ¨åˆ†</li>
<li><code>-s --suffix</code>ï¼špprof profile çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º <code>/debug/pprof/profile</code></li>
<li><code>--seconds</code>ï¼šè¦æ‰§è¡Œ profiling çš„æ—¶é—´é•¿åº¦ï¼Œé»˜è®¤ä¸º 30s</li>
</ul>
<p>è¦ç”Ÿæˆç«ç„°å›¾ï¼Œéœ€è¦äº‹å…ˆå®‰è£… <a href="https://github.com/brendangregg/FlameGraph" target="_blank" rel="noopener">FlameGraph</a>å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·çš„å®‰è£…å¾ˆç®€å•ï¼Œåªè¦æŠŠå¯¹åº”çš„å¯æ‰§è¡Œæ–‡ä»¶æ”¾åˆ° <code>$PATH</code> ç›®å½•ä¸‹å°±è¡Œã€‚</p>
<h2 id="å’Œæµ‹è¯•å·¥å…·çš„é›†æˆ"><a href="#å’Œæµ‹è¯•å·¥å…·çš„é›†æˆ" class="headerlink" title="å’Œæµ‹è¯•å·¥å…·çš„é›†æˆ"></a>å’Œæµ‹è¯•å·¥å…·çš„é›†æˆ</h2><p>go test å‘½ä»¤æœ‰ä¸¤ä¸ªå‚æ•°å’Œ pprof ç›¸å…³ï¼Œå®ƒä»¬åˆ†åˆ«æŒ‡å®šç”Ÿæˆçš„ CPU å’Œ Memory profiling ä¿å­˜çš„æ–‡ä»¶ï¼š</p>
<ul>
<li><code>-cpuprofile</code>ï¼šcpu profiling æ•°æ®è¦ä¿å­˜çš„æ–‡ä»¶åœ°å€</li>
<li><code>-memprofile</code>ï¼šmemory profiling æ•°æ®è¦æŠ¥æ–‡çš„æ–‡ä»¶åœ°å€</li>
</ul>
<p>æ¯”å¦‚ä¸‹é¢æ‰§è¡Œæµ‹è¯•çš„åŒæ—¶ï¼Œä¹Ÿä¼šæ‰§è¡Œ CPU profilingï¼Œå¹¶æŠŠç»“æœä¿å­˜åœ¨ <code>cpu.prof</code> æ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go <span class="built_in">test</span> -bench . -cpuprofile=cpu.prof</span></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æŸä¹‹åï¼Œå°±ä¼šç”Ÿæˆ <code>main.test</code> å’Œ <code>cpu.prof</code>  æ–‡ä»¶ã€‚è¦æƒ³ä½¿ç”¨ <code>go tool pprof</code>ï¼Œéœ€è¦æŒ‡å®šçš„äºŒè¿›åˆ¶æ–‡ä»¶å°±æ˜¯ <code>main.test</code>ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒProfiling ä¸€èˆ¬å’Œæ€§èƒ½æµ‹è¯•ä¸€èµ·ä½¿ç”¨ï¼Œè¿™ä¸ªåŸå› åœ¨å‰æ–‡ä¹Ÿæåˆ°è¿‡ï¼Œåªæœ‰åº”ç”¨åœ¨è´Ÿè½½é«˜çš„æƒ…å†µä¸‹ Profiling æ‰æœ‰æ„ä¹‰ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://blog.golang.org/profiling-go-programs" target="_blank" rel="noopener">The Go Blog: Profiling Go Programs</a></li>
<li><a href="https://github.com/hyper0x/go_command_tutorial/blob/master/0.12.md" target="_blank" rel="noopener">go command tutorial: go tool pprof   </a></li>
<li><a href="http://artem.krylysov.com/blog/2017/03/13/profiling-and-optimizing-go-web-applications/" target="_blank" rel="noopener">Profiling and optimizing Go web applications</a></li>
<li><a href="https://software.intel.com/en-us/blogs/2014/05/10/debugging-performance-issues-in-go-programs" target="_blank" rel="noopener">Debugging performance issues in Go programs</a></li>
</ul>

                </div>
            </section>
        </article>
    </div>
    
<nav class="pagination">
    
    
    <a class="prev-post" title="aufs ç®€ä»‹ä»¥åŠåœ¨ docker ä¸­çš„ä½¿ç”¨" href="/2017/09/13/docker-aufs-storage-driver/">
        â† aufs ç®€ä»‹ä»¥åŠåœ¨ docker ä¸­çš„ä½¿ç”¨
    </a>
    
    <span class="prev-next-post">â€¢</span>
    
    <a class="next-post" title="docker å®¹å™¨åŸºç¡€æŠ€æœ¯ï¼šlinux namespace ç®€ä»‹" href="/2017/08/29/linux-namespace/">
        docker å®¹å™¨åŸºç¡€æŠ€æœ¯ï¼šlinux namespace ç®€ä»‹ â†’
    </a>
    
    
</nav>
    
</main>

<div class="t-g-control">
    <div class="gotop">
        <svg class="icon" width="32px" height="32px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M793.024 710.272a32 32 0 1 0 45.952-44.544l-310.304-320a32 32 0 0 0-46.4 0.48l-297.696 320a32 32 0 0 0 46.848 43.584l274.752-295.328 286.848 295.808z" fill="#8a8a8a" /></svg>
    </div>
    <div class="toc-control">
        <svg class="icon toc-icon" width="32px" height="32.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M779.776 480h-387.2a32 32 0 0 0 0 64h387.2a32 32 0 0 0 0-64M779.776 672h-387.2a32 32 0 0 0 0 64h387.2a32 32 0 0 0 0-64M256 288a32 32 0 1 0 0 64 32 32 0 0 0 0-64M392.576 352h387.2a32 32 0 0 0 0-64h-387.2a32 32 0 0 0 0 64M256 480a32 32 0 1 0 0 64 32 32 0 0 0 0-64M256 672a32 32 0 1 0 0 64 32 32 0 0 0 0-64" fill="#8a8a8a" /></svg>
        <svg class="icon toc-close" style="display: none;" width="32px" height="32.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M512 960c-247.039484 0-448-200.960516-448-448S264.960516 64 512 64 960 264.960516 960 512 759.039484 960 512 960zM512 128.287273c-211.584464 0-383.712727 172.128262-383.712727 383.712727 0 211.551781 172.128262 383.712727 383.712727 383.712727 211.551781 0 383.712727-172.159226 383.712727-383.712727C895.712727 300.415536 723.551781 128.287273 512 128.287273z" fill="#8a8a8a" /><path d="M557.05545 513.376159l138.367639-136.864185c12.576374-12.416396 12.672705-32.671738 0.25631-45.248112s-32.704421-12.672705-45.248112-0.25631l-138.560301 137.024163-136.447897-136.864185c-12.512727-12.512727-32.735385-12.576374-45.248112-0.063647-12.512727 12.480043-12.54369 32.735385-0.063647 45.248112l136.255235 136.671523-137.376804 135.904314c-12.576374 12.447359-12.672705 32.671738-0.25631 45.248112 6.271845 6.335493 14.496116 9.504099 22.751351 9.504099 8.12794 0 16.25588-3.103239 22.496761-9.247789l137.567746-136.064292 138.687596 139.136568c6.240882 6.271845 14.432469 9.407768 22.65674 9.407768 8.191587 0 16.352211-3.135923 22.591372-9.34412 12.512727-12.480043 12.54369-32.704421 0.063647-45.248112L557.05545 513.376159z" fill="#8a8a8a" /></svg>
    </div>
    <div class="gobottom">
        <svg class="icon" width="32px" height="32.00px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M231.424 346.208a32 32 0 0 0-46.848 43.584l297.696 320a32 32 0 0 0 46.4 0.48l310.304-320a32 32 0 1 0-45.952-44.544l-286.848 295.808-274.752-295.36z" fill="#8a8a8a" /></svg>
    </div>
</div>
<div class="toc-main" style="right: -100%">
    <div class="post-toc">
        <span>TOC</span>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ä»€ä¹ˆæ˜¯-Profiling"><span class="toc-text">ä»€ä¹ˆæ˜¯ Profiling?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸¤ç§æ”¶é›†æ–¹å¼"><span class="toc-text">ä¸¤ç§æ”¶é›†æ–¹å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#å·¥å…·å‹åº”ç”¨"><span class="toc-text">å·¥å…·å‹åº”ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æœåŠ¡å‹åº”ç”¨"><span class="toc-text">æœåŠ¡å‹åº”ç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go-tool-pprof-å‘½ä»¤ï¼šè·å–å’Œåˆ†æ-Profiling-æ•°æ®"><span class="toc-text">go tool pprof å‘½ä»¤ï¼šè·å–å’Œåˆ†æ Profiling æ•°æ®</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU-Profiling"><span class="toc-text">CPU Profiling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory-Profiling"><span class="toc-text">Memory Profiling</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go-torch-å’Œç«ç„°å›¾"><span class="toc-text">go-torch å’Œç«ç„°å›¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å’Œæµ‹è¯•å·¥å…·çš„é›†æˆ"><span class="toc-text">å’Œæµ‹è¯•å·¥å…·çš„é›†æˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å‚è€ƒèµ„æ–™"><span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol>
    </div>
</div>



        

<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
            

<article class="read-next-card"  style="background-image: url(https://i.loli.net/2017/11/26/5a19c56faa29f.jpg)"  >
  <header class="read-next-card-header">
    <small class="read-next-card-header-sitetitle">&mdash; Cizixs Write Here &mdash;</small>
    <h3 class="read-next-card-header-title">Recent Posts</h3>
  </header>
  <div class="read-next-divider">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/>
    </svg>
  </div>
  <div class="read-next-card-content">
    <ul>
      
      
      
      <li>
        <a href="/2018/08/26/what-is-istio/">ä»€ä¹ˆæ˜¯ istio</a>
      </li>
      
      
      
      <li>
        <a href="/2018/08/25/knative-serverless-platform/">serverless å¹³å° knative ç®€ä»‹</a>
      </li>
      
      
      
      <li>
        <a href="/2018/06/25/kubernetes-resource-management/">kubernetes èµ„æºç®¡ç†æ¦‚è¿°</a>
      </li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
    </ul>
  </div>
  <footer class="read-next-card-footer">
    <a href="/archives">  MORE  â†’ </a>
  </footer>
</article>

            
            
            
        </div>
    </div>
</aside>

<footer class="site-footer outer">
	<div class="site-footer-content inner">
		<section class="copyright">
			<a href="/" title="Cizixs Write Here">Cizixs Write Here</a>
			&copy; 2018
		</section>
		<nav class="site-footer-nav">
			
            <a href="https://hexo.io" title="Hexo" target="_blank" rel="noopener">Hexo</a>
            <a href="https://github.com/xzhih/hexo-theme-casper" title="Casper" target="_blank" rel="noopener">Casper</a>
        </nav>
    </div>
</footer>






<div class="floating-header" >
	<div class="floating-header-logo">
        <a href="/" title="Cizixs Write Here">
			
                <img src="https://i.loli.net/2017/11/26/5a19c0b50432e.png" alt="Cizixs Write Here icon" />
			
            <span>Cizixs Write Here</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">ä½¿ç”¨ pprof å’Œç«ç„°å›¾è°ƒè¯• golang åº”ç”¨</div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>
<script>
   $(document).ready(function () {
    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');
    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }
    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }
    function update() {
        var rect = title.getBoundingClientRect();
        var trigger = rect.top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;
            // show/hide floating header
            if (lastScrollY >= trigger + triggerOffset) {
                header.classList.add('floating-active');
            } else {
                header.classList.remove('floating-active');
            }
            progressBar.setAttribute('max', progressMax);
            progressBar.setAttribute('value', lastScrollY);
            ticking = false;
        }

        window.addEventListener('scroll', onScroll, {passive: true});
        update();

        // TOC
        var width = $('.toc-main').width();
        $('.toc-control').click(function () {
            if ($('.t-g-control').css('width')=="50px") {
                if ($('.t-g-control').css('right')=="0px") {
                    $('.t-g-control').animate({right: width}, "slow");
                    $('.toc-main').animate({right: 0}, "slow");
                    toc_icon()
                } else {
                    $('.t-g-control').animate({right: 0}, "slow");
                    $('.toc-main').animate({right: -width}, "slow");
                    toc_icon()
                }
            } else {
                if ($('.toc-main').css('right')=="0px") {
                    $('.toc-main').slideToggle("fast", toc_icon());
                } else {
                    $('.toc-main').css('right', '0px');
                    toc_icon()
                }
            }
        })

        function toc_icon() {
            if ($('.toc-icon').css('display')=="none") {
                $('.toc-close').hide();
                $('.toc-icon').show();
            } else {
                $('.toc-icon').hide();
                $('.toc-close').show();
            }
        }

        $('.gotop').click(function(){
            $('html,body').animate({scrollTop:$('.post-full-header').offset().top}, 800);
        });
        $('.gobottom').click(function () {
            $('html,body').animate({scrollTop:$('.pagination').offset().top}, 800);
        });

        // highlight
        // https://highlightjs.org
        $('pre code').each(function(i, block) {
            hljs.highlightBlock(block);
        });
        $('td.code').each(function(i, block) {
            hljs.highlightBlock(block);
        });

        console.log("this theme is from https://github.com/xzhih/hexo-theme-casper")
    });
</script>



<link rel="stylesheet" href="https://cdn.staticfile.org/lightgallery/1.3.9/css/lightgallery.min.css">



<script src="https://cdn.staticfile.org/lightgallery/1.3.9/js/lightgallery.min.js"></script>


<script>
	$(function () {
		var postImg = $('#lightgallery').find('img');
		postImg.addClass('post-img');
		postImg.each(function () {
			var imgSrc = $(this).attr('src');
			$(this).attr('data-src', imgSrc);
		});
		$('#lightgallery').lightGallery({selector: '.post-img'});
	});
</script>




    </div>
</body>
</html>
